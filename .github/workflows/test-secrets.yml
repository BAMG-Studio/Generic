name: Test Secrets Configuration

on:
  workflow_dispatch:

jobs:
  test-secrets:
    name: Verify GitHub Secrets
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Check AWS credentials format
        run: |
          echo "✅ Checking AWS credentials..."
          echo "AWS_ACCESS_KEY_ID length: ${#AWS_ACCESS_KEY_ID}"
          echo "AWS_SECRET_ACCESS_KEY length: ${#AWS_SECRET_ACCESS_KEY}"
          echo "AWS_DEFAULT_REGION: $AWS_DEFAULT_REGION"
          echo "DVC_REMOTE_BUCKET: $DVC_REMOTE_BUCKET"
          
          # Validate format
          if [[ ! "$AWS_ACCESS_KEY_ID" =~ ^AKIA[A-Z0-9]{16}$ ]]; then
            echo "❌ AWS_ACCESS_KEY_ID format invalid"
            exit 1
          fi
          
          if [ ${#AWS_SECRET_ACCESS_KEY} -ne 40 ]; then
            echo "❌ AWS_SECRET_ACCESS_KEY should be 40 characters"
            exit 1
          fi
          
          echo "✅ AWS credentials format valid"
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: ${{ secrets.AWS_DEFAULT_REGION }}
          DVC_REMOTE_BUCKET: ${{ secrets.DVC_REMOTE_BUCKET }}
      
      - name: Test AWS S3 connection
        run: |
          echo "✅ Testing S3 connection..."
          pip install awscli
          aws s3 ls s3://${{ secrets.DVC_REMOTE_BUCKET }}/ || echo "Bucket is empty or doesn't exist"
          
          # Try to create a test file
          echo "test" > test.txt
          aws s3 cp test.txt s3://${{ secrets.DVC_REMOTE_BUCKET }}/ci-test/test.txt
          aws s3 rm s3://${{ secrets.DVC_REMOTE_BUCKET }}/ci-test/test.txt
          
          echo "✅ S3 connection successful"
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: ${{ secrets.AWS_DEFAULT_REGION }}
      
      - name: Check GitHub token
        run: |
          echo "✅ Checking GitHub token..."
          echo "FORGETRACE_GITHUB_TOKEN length: ${#FORGETRACE_GITHUB_TOKEN}"
          
          # Validate format
          if [[ ! "$FORGETRACE_GITHUB_TOKEN" =~ ^ghp_[A-Za-z0-9]{36}$ ]]; then
            echo "⚠️  FORGETRACE_GITHUB_TOKEN format may be invalid (expected ghp_...)"
          fi
          
          # Test GitHub API
          response=$(curl -s -H "Authorization: token $FORGETRACE_GITHUB_TOKEN" https://api.github.com/user)
          echo "GitHub API response: $response"
          
          echo "✅ GitHub token valid"
        env:
          FORGETRACE_GITHUB_TOKEN: ${{ secrets.FORGETRACE_GITHUB_TOKEN }}
      
      - name: Test MLflow connection
        run: |
          echo "✅ Testing MLflow connection..."
          echo "MLFLOW_TRACKING_URI: $MLFLOW_TRACKING_URI"
          
          # Test MLflow API
          response=$(curl -s "$MLFLOW_TRACKING_URI/api/2.0/mlflow/experiments/list")
          echo "MLflow API response: $response"
          
          if [[ "$response" == *"experiments"* ]]; then
            echo "✅ MLflow connection successful"
          else
            echo "⚠️  MLflow may not be accessible"
          fi
        env:
          MLFLOW_TRACKING_URI: ${{ secrets.MLFLOW_TRACKING_URI }}
        continue-on-error: true
      
      - name: Summary
        run: |
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "✅ SECRET VALIDATION COMPLETE"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "All required secrets are configured correctly."
          echo "You can now run production workflows."
