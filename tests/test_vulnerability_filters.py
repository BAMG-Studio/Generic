from pathlib import Path
from typing import Any, Dict, List

from forgetrace.scanners.vulnerabilities import VulnerabilityScanner


def _scanner(tmp_path: Path, filter_overrides: Dict[str, Any] | None = None) -> VulnerabilityScanner:
    config: Dict[str, Any] = {
        "vulnerability_scanning": {
            "filters": filter_overrides or {},
        }
    }
    scanner = VulnerabilityScanner(tmp_path, config)
    scanner.packages = [
        {"name": "pkg-one", "version": "1.0.0", "ecosystem": "PyPI", "file": "requirements.txt"},
        {"name": "pkg-two", "version": "2.0.0", "ecosystem": "PyPI", "file": "requirements.txt"},
    ]
    return scanner


def test_context_filters_respect_min_cvss(tmp_path: Path) -> None:
    scanner = _scanner(tmp_path, {"min_cvss_context": 6.0})
    vulnerabilities: List[Dict[str, Any]] = [
        {"severity": "HIGH", "cvss_score": 5.5, "confidence": "medium"},
        {"severity": "CRITICAL", "cvss_score": 7.2, "confidence": "high"},
    ]

    filtered, metrics = scanner._apply_context_filters(vulnerabilities)  # type: ignore[attr-defined]

    assert [round(float(v["cvss_score"]), 1) for v in filtered] == [7.2]
    assert metrics["normalized_vuln_density"] == 0.5
    assert metrics["noise_ratio"] == 0.5


def test_context_filters_apply_custom_weights(tmp_path: Path) -> None:
    scanner = _scanner(tmp_path, {"severity_weights": {"HIGH": 2.0}})
    vulnerabilities: List[Dict[str, Any]] = [
        {"severity": "HIGH", "cvss_score": 5.0, "confidence": "high"},
    ]

    filtered, metrics = scanner._apply_context_filters(vulnerabilities)  # type: ignore[attr-defined]

    assert len(filtered) == 1
    assert metrics["weighted_vuln_score"] == 10.0
    assert metrics["normalized_vuln_density"] == 0.5


def test_context_filters_respect_confidence_floor(tmp_path: Path) -> None:
    scanner = _scanner(tmp_path, {"confidence_floor": "high"})
    vulnerabilities: List[Dict[str, Any]] = [
        {"severity": "HIGH", "cvss_score": 8.0, "confidence": "medium"},
    ]

    filtered, metrics = scanner._apply_context_filters(vulnerabilities)  # type: ignore[attr-defined]

    assert filtered == []
    assert metrics["noise_ratio"] == 1.0
    assert metrics["normalized_vuln_density"] == 0.0


def test_context_filters_allow_unknown_when_configured(tmp_path: Path) -> None:
    scanner = _scanner(tmp_path, {"drop_unknown_severity": False})
    vulnerabilities: List[Dict[str, Any]] = [
        {"severity": "UNKNOWN", "cvss_score": 4.0, "confidence": "medium"},
    ]

    filtered, metrics = scanner._apply_context_filters(vulnerabilities)  # type: ignore[attr-defined]

    assert len(filtered) == 1
    assert abs(metrics["weighted_vuln_score"] - 1.6) < 1e-3
    assert metrics["noise_ratio"] == 0.0
