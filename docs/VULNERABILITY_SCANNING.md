# Vulnerability Scanning

ForgeTrace includes comprehensive vulnerability scanning that queries multiple security databases to identify known vulnerabilities in project dependencies.

## Features

### Multi-Source Detection

The vulnerability scanner aggregates data from:

1. **OSV (Open Source Vulnerabilities)** - Free, no API key required
   - Aggregates data from multiple sources (GitHub, NVD, PyPI, npm, etc.)
   - Comprehensive coverage across ecosystems
   - Real-time updates

2. **GitHub Advisory Database** - Public security advisories
   - First-party security reports
   - Community-contributed advisories
   - Integration with Dependabot alerts

3. **OWASP Dependency-Check** - Optional, local scanning
   - Deep SBOM analysis
   - CVE correlation
   - Custom vulnerability databases

### Supported Ecosystems

- **Python**: requirements.txt, Pipfile.lock
- **Node.js**: package.json, package-lock.json
- **Go**: go.mod
- **Ruby**: Gemfile.lock
- **More coming**: Maven (Java), Cargo (Rust), NuGet (.NET)

## Configuration

Edit `config.yaml` to customize vulnerability scanning and tune noise suppression:

```yaml
vulnerability_scanning:
  enabled: true
  sources:
    - OSV  # Open Source Vulnerabilities (recommended)
    - GitHub  # GitHub Advisory Database
    - OWASP  # OWASP Dependency-Check (requires tool)
  severity_threshold: "MEDIUM"  # Minimum severity to surface
  fail_on_critical: false  # Fail audit if critical vulns detected
  filters:
    min_cvss_ingest: 4.0       # Discard low-score OSV entries before merging
    min_cvss_context: 3.5      # Final filter to keep only actionable issues
    confidence_floor: "medium"  # none | low | medium | high
    drop_unknown_severity: true
    severity_weights:
      CRITICAL: 1.5
      HIGH: 1.3
      MEDIUM: 1.0
      LOW: 0.6
      UNKNOWN: 0.4
```

### Noise Filtering Controls

- **min_cvss_ingest**: Rejects low CVSS issues before they enter the dataset.
- **min_cvss_context**: Applies a second pass after deduplication to keep remediation lists focused.
- **confidence_floor**: Enforces provenance quality from OSV (e.g., drop "LOW" confidence entries).
- **drop_unknown_severity**: Removes advisories without a normalized severity label.
- **severity_weights**: Customize weighted scoring for executive reporting and ML features.

### Tool Installation (Optional)

**OWASP Dependency-Check** (optional but recommended):

```bash
# Download and install
wget https://github.com/jeremylong/DependencyCheck/releases/download/v8.4.0/dependency-check-8.4.0-release.zip
unzip dependency-check-8.4.0-release.zip
export PATH=$PATH:$(pwd)/dependency-check/bin

# Update config.yaml
tools:
  owasp_dependency_check: "/path/to/dependency-check/bin/dependency-check.sh"
```

## Usage

Vulnerability scanning runs automatically during audit:

```bash
forgetrace audit /path/to/repo --out ./output
```

View results in:

- **JSON**: `output/audit.json` → `findings.vulnerabilities`
- **HTML Report**: `output/report.html` → Vulnerability section
- **PDF Report**: `output/executive_summary.pdf` → Security section

## Output Format

### Vulnerability Object

```json
{
  "package": "requests",
  "version": "2.25.0",
  "ecosystem": "PyPI",
  "vulnerability_id": "CVE-2023-32681",
  "summary": "Proxy-Authorization header leak on redirects",
  "details": "...",
  "severity": "HIGH",
  "cvss_score": 7.5,
  "risk_score": 9.0,
  "priority": "HIGH",
  "references": [
    "https://nvd.nist.gov/vuln/detail/CVE-2023-32681",
    "https://github.com/psf/requests/security/advisories/GHSA-j8r2-6x86-q33q"
  ],
  "source": "OSV",
  "file": "requirements.txt"
}
```

### Summary Statistics

```json
{
  "total_packages": 42,
  "vulnerable_packages": 5,
  "total_vulnerabilities": 8,
  "by_severity": {
    "CRITICAL": 1,
    "HIGH": 3,
    "MEDIUM": 3,
    "LOW": 1,
    "UNKNOWN": 0
  },
  "scan_timestamp": "2025-11-03T10:30:00.000Z"
}
```

### Context Metrics

ForgeTrace now emits repository-level metrics that flow into HTML/PDF reports **and** the ML training pipeline:

- `normalized_vuln_density`: Vulnerable packages ÷ total packages.
- `weighted_vuln_score`: CVSS-weighted severity score using the configured weights.
- `osv_noise_ratio`: Percentage of raw OSV hits filtered out as noise.

These metrics populate KPI cards, narrative summaries, and per-file training features (prefixed with `repo_`). Downstream models can now reason about macro security posture when classifying file-level IP origin.

## Risk Scoring

Each vulnerability receives a **risk score** (0-10) based on:

- **CVSS Base Score**: Industry-standard severity rating
- **Severity Multiplier**:
  - CRITICAL: 1.3x
  - HIGH: 1.2x
  - MEDIUM: 1.0x
  - LOW: 0.7x
  - UNKNOWN: 0.5x

### Priority Levels

- **CRITICAL**: Risk Score ≥ 9.0 → Immediate action required
- **HIGH**: Risk Score ≥ 7.0 → Address within 30 days
- **MEDIUM**: Risk Score ≥ 4.0 → Address within 90 days
- **LOW**: Risk Score < 4.0 → Monitor and review

## Best Practices

### 1. Regular Scanning

```bash
# Run nightly scans
0 2 * * * forgetrace audit /path/to/repo --out /scans/$(date +\%Y-\%m-\%d)
```

### 2. CI/CD Integration

```yaml
# .github/workflows/vulnerability-scan.yml
name: Vulnerability Scan
on: [push, pull_request]
jobs:
  scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Run ForgeTrace
        run: |
          pip install forgetrace
          forgetrace audit . --out ./scan-results
      - name: Check for critical vulnerabilities
        run: |
          CRITICAL=$(jq '.vulnerabilities.by_severity.CRITICAL' ./scan-results/audit.json)
          if [ "$CRITICAL" -gt 0 ]; then
            echo "❌ Found $CRITICAL critical vulnerabilities"
            exit 1
          fi
```

### 3. Policy Enforcement

Enable `fail_on_critical` in `config.yaml` to block deployments with critical vulnerabilities:

```yaml
vulnerability_scanning:
  fail_on_critical: true
```

### 4. Dependency Updates

Use scan results to prioritize dependency updates:

```bash
# Generate vulnerability report
forgetrace audit . --out ./scan

# Review high-priority vulnerabilities
jq '.vulnerabilities.vulnerabilities[] | select(.priority == "CRITICAL" or .priority == "HIGH")' ./scan/audit.json
```

## Troubleshooting

### OSV API Rate Limiting

OSV is rate-limited to **~100 requests/minute**. For large projects:

1. Use OWASP Dependency-Check (local, no rate limits)
2. Implement caching (scan results valid for 24 hours)
3. Batch scan multiple repos with delays

### False Positives

To exclude specific vulnerabilities:

```yaml
# config.yaml (future feature)
vulnerability_scanning:
  exclude_vulnerabilities:
    - CVE-2023-XXXXX  # False positive: not applicable to our use case
    - GHSA-xxxx-xxxx-xxxx  # Dependency not used in production
```

### No Vulnerabilities Found

If scan reports 0 vulnerabilities but you expect findings:

1. Verify package files are present (`requirements.txt`, `package.json`, etc.)
2. Check version specifiers are exact (not wildcards like `*`)
3. Ensure network connectivity to OSV API
4. Review logs for parsing errors

## API Reference

### VulnerabilityScanner Class

```python
from forgetrace.scanners import VulnerabilityScanner

scanner = VulnerabilityScanner(repo_path="/path/to/repo", config=config_dict)
results = scanner.scan()
```

#### Methods

- `scan() -> Dict[str, Any]`: Run full vulnerability scan
- `_extract_packages() -> List[Dict]`: Extract packages from repo
- `_query_osv() -> List[Dict]`: Query OSV database
- `_run_owasp_check() -> List[Dict]`: Run OWASP Dependency-Check

## Contributing

To add support for new ecosystems (Maven, Cargo, etc.):

1. Add parser method: `_parse_<ecosystem>_lock()`
2. Update `_extract_packages()` to call new parser
3. Map ecosystem name to OSV format
4. Add tests for new parser

See `forgetrace/scanners/vulnerabilities.py` for examples.
