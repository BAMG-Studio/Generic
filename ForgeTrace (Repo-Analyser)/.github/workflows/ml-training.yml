name: ML Training Pipeline

on:
  workflow_dispatch:
    inputs:
      phase:
        description: 'Training phase to run'
        required: true
        default: 'ALL'
        type: choice
        options:
          - ALL
          - FOUNDATIONAL
          - POLYGLOT
          - SECURITY
          - ENTERPRISE
          - RESEARCH
      tiers:
        description: 'Optional comma-separated tier list (e.g., 1,2) for large phases'
        required: false
        default: ''
        type: string
      dry_run:
        description: 'Skip extraction/training to validate configuration'
        required: false
        default: false
        type: boolean
      force_retrain:
        description: 'Force model retraining even if cached'
        required: false
        default: false
        type: boolean
  schedule:
    # Run weekly on Sundays at 2 AM UTC
    - cron: '0 2 * * 0'

env:
  PYTHON_VERSION: '3.12'

jobs:
  train:
    name: Train ML Model
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write
    steps:
      - name: Free disk space
        run: |
          echo "Available disk space before cleanup:"
          df -h
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo docker image prune --all --force
          echo "Available disk space after cleanup:"
          df -h
      
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for git analysis

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install DVC for preflight
        run: |
          python -m pip install --upgrade pip
          pip install --quiet dvc
      
      - name: Run preflight checks
        env:
          SELECTED_PHASE: ${{ github.event.inputs.phase || 'ALL' }}
          IS_DRY_RUN: ${{ github.event.inputs.dry_run || 'false' }}
          FORGETRACE_MIN_DISK_GB: ${{ github.event.inputs.dry_run == 'true' && '35' || '' }}
        run: |
          chmod +x scripts/preflight_check.sh
          PHASE_NORMALIZED=$(echo "${SELECTED_PHASE}" | tr '[:lower:]' '[:upper:]')
          scripts/preflight_check.sh --phase "$PHASE_NORMALIZED"
          echo "DRY_RUN=${IS_DRY_RUN}" >> $GITHUB_ENV
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_DEFAULT_REGION }}
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .
          pip install mlflow dvc scikit-learn pandas numpy
      
      - name: Configure DVC
        if: ${{ github.event.inputs.dry_run != 'true' }}
        run: |
          dvc remote add -d s3remote s3://${{ secrets.DVC_REMOTE_BUCKET }}/dvc-storage
          dvc remote modify s3remote region ${{ secrets.AWS_DEFAULT_REGION }}
      
      - name: Pull existing data (if any)
        if: ${{ github.event.inputs.dry_run != 'true' }}
        run: dvc pull || true
        continue-on-error: true
      
      - name: Set MLflow tracking URI
        run: echo "MLFLOW_TRACKING_URI=${{ secrets.MLFLOW_TRACKING_URI }}" >> $GITHUB_ENV
      
      - name: Run training pipeline
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          MLFLOW_USERNAME: ${{ secrets.MLFLOW_USERNAME }}
          MLFLOW_PASSWORD: ${{ secrets.MLFLOW_PASSWORD }}
          SELECTED_PHASE: ${{ github.event.inputs.phase || 'ALL' }}
          SELECTED_TIERS: ${{ github.event.inputs.tiers || '' }}
          IS_DRY_RUN: ${{ github.event.inputs.dry_run || 'false' }}
        run: |
          PHASE_NORMALIZED=$(echo "${SELECTED_PHASE}" | tr '[:lower:]' '[:upper:]')
          CLI_ARGS=(--phase "$PHASE_NORMALIZED")
          if [ -n "${SELECTED_TIERS}" ]; then
            CLI_ARGS+=(--tiers "${SELECTED_TIERS}")
          fi
          if [ "${IS_DRY_RUN}" = "true" ]; then
            CLI_ARGS+=(--dry-run)
          fi
          python scripts/run_training_pipeline.py "${CLI_ARGS[@]}"
      
      - name: Train Random Forest model
        if: ${{ github.event.inputs.dry_run != 'true' }}
        env:
          MLFLOW_TRACKING_URI: ${{ secrets.MLFLOW_TRACKING_URI }}
          MLFLOW_USERNAME: ${{ secrets.MLFLOW_USERNAME }}
          MLFLOW_PASSWORD: ${{ secrets.MLFLOW_PASSWORD }}
          SELECTED_PHASE: ${{ github.event.inputs.phase || 'ALL' }}
        run: |
          PHASE_NORMALIZED=$(echo "${SELECTED_PHASE}" | tr '[:lower:]' '[:upper:]')
          python scripts/train_random_forest.py \
            --phase "$PHASE_NORMALIZED" \
            --input training_output/dataset/complete_training_dataset.jsonl \
            --output models/ip_classifier_rf.pkl \
            --mlflow-experiment forgetrace-training
      
      - name: Run model validation
        if: ${{ github.event.inputs.dry_run != 'true' }}
        run: |
          python scripts/analyze_feature_importance.py \
            --model models/ip_classifier_rf.pkl \
            --output training_output/model_analysis.json
      
      - name: Commit training artifacts
        if: ${{ github.event.inputs.dry_run != 'true' }}
        run: |
          dvc add models/ip_classifier_rf.pkl
          dvc add training_output/dataset/
          dvc push
      
      - name: Create training report
        if: ${{ github.event.inputs.dry_run != 'true' }}
        run: |
          echo "# Training Report - $(date +%Y-%m-%d)" > training_report.md
          echo "" >> training_report.md
          echo "## Model Metrics" >> training_report.md
          cat training_output/model_analysis.json >> training_report.md
      
      - name: Upload training artifacts
        if: ${{ github.event.inputs.dry_run != 'true' }}
        uses: actions/upload-artifact@v4
        with:
          name: training-artifacts-${{ github.sha }}
          path: |
            models/ip_classifier_rf.pkl
            training_output/
            training_report.md
      
      - name: Commit model version
        if: github.ref == 'refs/heads/main' && github.event.inputs.dry_run != 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add models/ip_classifier_rf.pkl.dvc training_output/dataset.dvc
          git commit -m "chore: update ML model - $(date +%Y-%m-%d)" || true
          git push || true

  evaluate:
    name: Model Evaluation
    needs: train
    if: ${{ github.event.inputs.dry_run != 'true' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Download training artifacts
        uses: actions/download-artifact@v4
        with:
          name: training-artifacts-${{ github.sha }}
      
      - name: Install dependencies
        run: |
          pip install scikit-learn pandas numpy matplotlib seaborn
      
      - name: Run model interpretability
        run: |
          python scripts/model_interpretability.py \
            --model models/ip_classifier_rf.pkl \
            --output training_output/interpretability/
      
      - name: Generate performance report
        run: |
          python scripts/production_monitor.py \
            --model models/ip_classifier_rf.pkl \
            --baseline-accuracy 0.999 \
            --output training_output/performance_report.json
      
      - name: Upload evaluation results
        uses: actions/upload-artifact@v4
        with:
          name: evaluation-results
          path: training_output/interpretability/
