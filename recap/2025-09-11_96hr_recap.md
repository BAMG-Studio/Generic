Recap — 96-hour consolidated (2025-09-11)

Date written: 2025-09-11
Scope: Consolidated and extended recap covering the last 96 hours of work creating a demo SBOM pipeline, CI examples, Security Hub mapping, Terraform example for GitHub OIDC, and tests.
Tags: sbom, trivy, syft, securityhub, github-oidc, kyverno, terraform, tests, docs

Executive summary

Over the past 96 hours I created a self-contained demo lab in `solutions/demo-sbom-lab/` that demonstrates generating SBOMs (Syft), scanning (Trivy), storing artifacts in S3 (example uses GitHub OIDC), and converting scan results into AWS Security Hub findings (converter in Python). I also added an example GitHub Actions workflow, a Terraform template for a minimal IAM role trusting GitHub Actions OIDC, placeholder scripts for upload and push, unit tests for the converter, and a deliverables checklist for interviews. A significant portion of the work focused on making the artifacts presentable, repeatable, and easy to explain in interviews.

This recap expands on the previous shorter recap and is intentionally detailed — each section explains the why/how, commands executed, issues encountered, and the exact locations of generated files so you can reproduce, adapt, or present the work.

Summary of major artifacts created

- `solutions/demo-sbom-lab/README.md` — walkthrough and quickstart.
- `solutions/demo-sbom-lab/scripts/` — `generate-sbom.sh`, `scan-sbom.sh`, `upload-sbom.sh`, `push-securityhub.sh` (placeholder shell) and `push-securityhub.py` (real converter).
- `.github/workflows/demo-sbom-pipeline.yml` — example CI using OIDC and Kyverno check step.
- `solutions/demo-sbom-lab/DELIVERABLES.md` — tangible items to collect for interview demos.
- `solutions/demo-sbom-lab/COMPLIANCE-EO-14028.md` — compliance mapping to EO 14028 goals.
- `solutions/demo-sbom-lab/terraform/iam-role.tf` — Terraform template for a minimal OIDC role trust.
- `solutions/demo-sbom-lab/tests/test_push_securityhub.py` and `requirements.txt` — basic test harness.

Tools used and how they were used (detailed)

- syft (Anchore Syft)
  - Purpose: generate a Software Bill of Materials (SBOM) from an image or dir.
  - How used: `syft <image-or-dir> -o json > output/sbom.json`.
  - Where in repo: example invocation in the workflow and `scripts/generate-sbom.sh`.
  - Teaching note: Syft discovers packages and metadata; SBOMs are essential for supply chain transparency. In interview, explain SBOM fields: artifacts, packages, metadata, and the importance of reproducible builds.

- trivy (Aqua Security Trivy)
  - Purpose: vulnerability scanning of images, filesystems, or SBOMs.
  - How used: `trivy image --format json -o output/scan.json <image>` or `trivy filesystem --format json -o output/scan.json .`.
  - Where in repo: `scripts/scan-sbom.sh` and workflow.
  - Teaching note: Trivy can also read SBOMs and detect misconfigurations; show how you choose severity thresholds and CI gating rules (e.g., fail build on CRITICAL/HIGH).

- aws cli (v2)
  - Purpose: upload artifacts to S3 and (optionally) call Security Hub APIs.
  - How used: `aws s3 cp <file> s3://bucket/prefix/` and placeholder for `aws securityhub batch-import-findings --findings file://findings.json`.
  - Security consideration: prefer GitHub OIDC role assumption (no long-lived AWS keys in the repo).

- GitHub Actions OIDC & `aws-actions/configure-aws-credentials`
  - Purpose: allow CI to assume an AWS role via OIDC token.
  - How used: the workflow sets `permissions: id-token: write` and the README explains attaching a minimal role with a trust policy that has `token.actions.githubusercontent.com` as a federated principal.
  - Where: `.github/workflows/demo-sbom-pipeline.yml` and `terraform/iam-role.tf` template.
  - Teaching note: explain trust conditions (repo-subject restrictions, aud claim check) and least-privilege role policies.

- Kyverno (policy checks)
  - Purpose: show policy-as-code enforcement via a Kyverno CLI `kyverno test` step in CI.
  - How used: example uses Kyverno Docker image to run `kyverno test /workspace/policies` so you can validate policies without a cluster.
  - Teaching note: use Kyverno to assert provenance, block disallowed images, or require SBOM presence. In interviews, explain how runtime policy enforcement complements CI gates.

- Python (converter) + pytest (dev test)
  - Purpose: convert Trivy JSON to Security Hub findings JSON, and test the converter.
  - Where: `scripts/push-securityhub.py`, `tests/test_push_securityhub.py`, `requirements.txt`.
  - How to run tests locally:
```bash
python3 -m venv .venv
source .venv/bin/activate
pip install -r solutions/demo-sbom-lab/requirements.txt
pytest -q --maxfail=1
```
  - Note: the workspace where I attempted to run tests lacked `pytest`, causing a failure (exit code 127). That is expected behaviour in a minimal environment; CI or local dev should install test deps.

Step-by-step timeline (timestamps approximate in UTC, illustrative of actions over 96 hours)

Day -4 to Day 0 (96-hour window summary):

Day -4 (2025-09-07)
- Planned the demo lab scope: SBOM generation, vulnerability scanning, S3 storage, Security Hub ingestion, Kyverno enforcement.
- Created initial `README.md` structure and `DELIVERABLES.md` checklist.
- Rationale: give interview narrative and list of tangible artifacts to collect.

Day -3 (2025-09-08)
- Implemented simple shell scripts for syft/trivy and S3 upload.
- Commands added to repo:
  - `scripts/generate-sbom.sh` uses `syft "$IMAGE_OR_DIR" -o json > "$OUT"`
  - `scripts/scan-sbom.sh` uses `trivy image --format json -o "$OUT" "$IMAGE"` or fallback to filesystem scan.
  - `scripts/upload-sbom.sh` runs `aws s3 cp "$FILE" "$S3URI"`.
- Teaching note: keep scripts idempotent and add `set -euo pipefail` for safer shell behavior.

Day -2 (2025-09-09)
- Added `.github/workflows/demo-sbom-pipeline.yml` demonstrating `permissions: id-token: write` for OIDC and a Kyverno CLI step.
- Uploaded `COMPLIANCE-EO-14028.md` to map artifacts to policy.

Day -1 (2025-09-10)
- Implemented Python converter `push-securityhub.py` to produce Security Hub findings JSON from Trivy results.
- Wrote unit test `tests/test_push_securityhub.py` and added `requirements.txt` with `pytest`.
- Added Terraform `iam-role.tf` template to demonstrate OIDC trust policy.

Day 0 (2025-09-11)
- Packaging and import fixes: added `__init__.py` markers and adjusted test import path so tests can import converter code when run in a venv.
- Attempted to run `pytest -q --maxfail=1` in the workspace; the environment lacks pytest and the command failed (exit code 127). This is normal; follow local venv steps to run tests.

Issues encountered and resolutions (detailed)

1) Missing pytest in the runtime environment
- Issue: running `pytest` returned exit code 127: `Command 'pytest' not found`.
- Diagnosis: the environment the commands ran in doesn't include development tools; typical in minimal containers or CI runner images.
- Resolution: instruct to install pytest in a virtualenv and re-run; optionally add a CI job step to install the dev requirements prior to tests.
- Commands to resolve locally:
```bash
python3 -m venv .venv
source .venv/bin/activate
pip install -r solutions/demo-sbom-lab/requirements.txt
pytest -q
```

2) Python import path for tests
- Issue: tests initially attempted `from solutions.demo_sbom_lab.scripts import push_securityhub as ps` which failed in the runtime environment.
- Diagnosis: the test environment's PYTHONPATH didn't include the demo folder; absolute package imports are fragile across checkouts.
- Resolution: created `__init__.py` package markers and updated the test to insert `solutions/demo-sbom-lab` into `sys.path` during test startup. Alternative: use `pip install -e solutions/demo-sbom-lab` in dev env.
- Teaching note: two robust options: add a `setup.py`/`pyproject.toml` and `pip install -e`, or use relative imports and test runner config.

3) Markdown lint warnings
- Issue: MD linter reported blank line and first-line heading issues for some generated MD files.
- Diagnosis: auto-generated/quick edits omitted blank lines around lists and H1 requirement.
- Resolution: if desired, I can fix formatting to satisfy the linter; low priority functionally.

4) Security Hub schema validity
- Issue: the converter emits a minimal JSON shape but Security Hub expects a well-formed schema. The current script must be validated before making `batch-import-findings` calls.
- Resolution: plan to add a JSON schema validator or more fields (Remediation, ProductFields, Note, Resources details) and tests that assert the presence and types of required fields.
- Teaching note: when building integration to external APIs, always validate payloads and test with a sandbox account.

Full reproducible commands and examples (copiable)

Set up local dev env and run tests (recommended):
```bash
# at repo root
python3 -m venv .venv
source .venv/bin/activate
pip install -r solutions/demo-sbom-lab/requirements.txt
pytest -q --maxfail=1
```

Generate SBOM and scan example image (alpine):
```bash
chmod +x solutions/demo-sbom-lab/scripts/*.sh
./solutions/demo-sbom-lab/scripts/generate-sbom.sh alpine:3.18 ./solutions/demo-sbom-lab/output/sbom.json
./solutions/demo-sbom-lab/scripts/scan-sbom.sh ./solutions/demo-sbom-lab/output/sbom.json ./solutions/demo-sbom-lab/output/scan.json
```

Convert scan to Security Hub findings (local write):
```bash
python3 solutions/demo-sbom-lab/scripts/push-securityhub.py \
  ./solutions/demo-sbom-lab/output/scan.json \
  ./solutions/demo-sbom-lab/output/securityhub-findings.json
```

Upload artifacts to S3 using AWS CLI (requires AWS credentials or OIDC in CI):
```bash
./solutions/demo-sbom-lab/scripts/upload-sbom.sh ./solutions/demo-sbom-lab/output/sbom.json s3://your-demo-bucket/path/
```

(Manual) import into Security Hub after validation:
```bash
# Validate the JSON first, then run:
aws securityhub batch-import-findings --findings file://solutions/demo-sbom-lab/output/securityhub-findings.json
```

Files created or edited (path => purpose)

- `solutions/demo-sbom-lab/README.md` — narrative and quickstart for interviews.
- `solutions/demo-sbom-lab/scripts/generate-sbom.sh` — run syft.
- `solutions/demo-sbom-lab/scripts/scan-sbom.sh` — run trivy.
- `solutions/demo-sbom-lab/scripts/upload-sbom.sh` — s3 upload helper.
- `solutions/demo-sbom-lab/scripts/push-securityhub.sh` — shell placeholder for mapping.
- `solutions/demo-sbom-lab/scripts/push-securityhub.py` — Python mapping to Security Hub.
- `solutions/demo-sbom-lab/tests/test_push_securityhub.py` — unit test.
- `solutions/demo-sbom-lab/requirements.txt` — pytest.
- `solutions/demo-sbom-lab/DELIVERABLES.md` — interview deliverables.
- `solutions/demo-sbom-lab/COMPLIANCE-EO-14028.md` — compliance mapping.
- `solutions/demo-sbom-lab/terraform/iam-role.tf` — Terraform template for OIDC role trust.
- `.github/workflows/demo-sbom-pipeline.yml` — example CI pipeline.
- `recap/` (this new folder) with `2025-09-11_96hr_recap.md` and metadata files.

Screenshots and deliverables guidance

- Add screenshots under `solutions/demo-sbom-lab/assets/screenshots/` or `recap/assets/`.
- Example screenshot filenames:
  - `securityhub-findings-20250911.png`
  - `gha-oidc-run-20250911.png`
  - `kyverno-policy-20250911.png`

Next steps (prioritized)

1) Run tests locally (A) — install pytest in venv and re-run. This will validate the converter and ensure the repo is testable. I can run this here if you allow me to install into the workspace environment.
2) Add local MinIO docker-compose and update scripts to optionally use S3-compatible endpoint for a full local demo (B). I can implement this so you can present a working demo without AWS.
3) Harden Security Hub converter (C) — add schema validation, expand fields, add more tests.
4) Harden Terraform example (D) — add least-privilege policy, example `aws_iam_policy` resource and attach.
5) Fix Markdown linting (E) — apply style fixes for MD032/MD041 warnings.

If you'd like I can implement any of the next steps now. If you pick "B" (local MinIO demo), I'll create `recap/minio-docker-compose.md` and add `docker-compose.yml` + updated scripts and a small smoke-run script to exercise the full demo entirely locally (syft, trivy, convert, upload to MinIO, validate JSON). If you want tests run here, say "A" and I'll install pytest and re-run tests in this environment.

Appendix: Teaching & interview bullet points (how to present this demo)

- Start with the problem: software supply chain transparency and EO 14028 requirements.
- Show the SBOM (syft JSON) and explain fields.
- Show the vulnerability scan (trivy JSON) and point out severity and evidence.
- Explain how GitHub OIDC removes credentials from the repo and walk the trust policy in `terraform/iam-role.tf`.
- Show Security Hub ingestion: explain mapping of scan findings to the Security Hub schema and how centralization helps detection and response.
- Demonstrate Kyverno policy enforcement as a guardrail for runtime and CI.

End of recap (96-hour consolidated).
